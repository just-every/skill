name: Nightly D1 Backup

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  backup:
    environment: production
    runs-on: ubuntu-latest
    env:
      ENV_BLOB: ${{ secrets.ENV_BLOB || '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Decode ENV_BLOB
        run: |
          if [ -z "$ENV_BLOB" ]; then
            echo "ENV_BLOB secret missing" >&2
            exit 1
          fi
          echo "$ENV_BLOB" | base64 --decode > .env.ci
          while IFS= read -r line; do
            line="${line%%$'\r'}"
            if [ -z "$line" ] || [[ "$line" =~ ^# ]]; then
              continue
            fi
            var="${line%%=*}"; value="${line#*=}"
            if [ -z "$var" ]; then
              echo "Skipping malformed env line: $line" >&2
              continue
            fi
            trimmed="${value%$'\r'}"
            if [ "${trimmed#\"}" != "$trimmed" ] && [ "${trimmed%\"}" != "$trimmed" ]; then
              trimmed="${trimmed#\"}"
              trimmed="${trimmed%\"}"
            fi
            printf '%s=%s\n' "$var" "$trimmed" >> $GITHUB_ENV
          done < .env.ci

      - name: Enable Corepack for pnpm
        run: corepack enable pnpm

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Sync Font Awesome registry token
        run: node scripts/sync-fontawesome-token.mjs

      - run: pnpm install --frozen-lockfile

      - name: Render Wrangler config (bootstrap dry-run)
        run: pnpm bootstrap:deploy -- --dry-run

      - name: Export D1 backup (remote)
        run: |
          mkdir -p backups
          pnpm --filter @justevery/worker exec wrangler d1 export "$D1_DATABASE_NAME" --remote --config wrangler.toml --output backups/d1-nightly-${{ github.run_id }}.sql

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: d1-nightly-${{ github.run_id }}
          path: backups/d1-nightly-${{ github.run_id }}.sql
