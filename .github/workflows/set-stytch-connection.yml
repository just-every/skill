name: Set Stytch Connection

on:
  workflow_dispatch:
    inputs:
      connection_id:
        description: "Live Stytch connection ID (conn-live-...)"
        required: true
        type: string
      deploy:
        description: "Deploy worker after updating secret"
        required: false
        default: false
        type: boolean

jobs:
  update-secret:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Stytch connection ID secret
        working-directory: workers/api
        run: |
          echo "${{ inputs.connection_id }}" | npx --yes wrangler@4 secret put STYTCH_SSO_CONNECTION_ID --config wrangler.toml

      - name: Deploy Worker
        if: inputs.deploy == true
        working-directory: workers/api
        run: npx --yes wrangler@4 deploy --config wrangler.toml
