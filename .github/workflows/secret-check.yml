name: Secret Check (ENV_BLOB)

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request to notify'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-secret:
    runs-on: ubuntu-latest
    env:
      ENV_BLOB: ${{ secrets.ENV_BLOB || '' }}
    steps:
      - name: Evaluate ENV_BLOB presence
        id: eval
        run: |
          if [ -z "$ENV_BLOB" ]; then
            echo "status=missing" >> "$GITHUB_OUTPUT"
            echo "message=⚠️ ENV_BLOB secret is missing; add it to the production environment before running deploy." >> "$GITHUB_OUTPUT"
          else
            echo "status=present" >> "$GITHUB_OUTPUT"
            echo "message=✅ ENV_BLOB secret detected; deploy mode can proceed." >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.eval.outputs.status }}';
            const message = ${{ toJSON(steps.eval.outputs.message) }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
              body: `ENV_BLOB secret check (${status}):\n\n${message}`
            });

      - name: Apply needs-secret label when missing
        if: steps.eval.outputs.status == 'missing'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
              labels: ['needs-secret']
            });
