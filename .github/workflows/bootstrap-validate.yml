name: Bootstrap Validation

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Force mode (local|remote)'
        required: false
      base:
        description: 'Override base URL'
        required: false

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID || '' }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN || '' }}
      CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID || '' }}
      LOGTO_APPLICATION_ID: ${{ secrets.LOGTO_APPLICATION_ID || '' }}
      LOGTO_TOKEN: ${{ secrets.LOGTO_TOKEN || '' }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY || secrets.STRIPE_TEST_SECRET_KEY || '' }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET || '' }}
      D1_DATABASE_NAME: ${{ secrets.D1_DATABASE_NAME || '' }}
      R2_BUCKET: ${{ secrets.R2_BUCKET || '' }}
      LANDING_URL: ${{ secrets.BOOTSTRAP_BASE_URL || secrets.LANDING_URL || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Assert required secrets
        run: npm run assert:secrets

      - name: Assert Cloudflare token scopes
        run: npm run assert:r2

      - name: Run bootstrap validation
        id: run-validation
        run: |
          set -euo pipefail

          MODE="${{ inputs.mode || '' }}"
          if [ -z "$MODE" ]; then
            if [ -n "$CLOUDFLARE_ACCOUNT_ID" ] && [ -n "$CLOUDFLARE_API_TOKEN" ] \
               && [ -n "$LOGTO_APPLICATION_ID" ] \
               && [ -n "$STRIPE_SECRET_KEY" ]; then
              MODE="remote"
            else
              MODE="local"
            fi
          fi

          BASE="${{ inputs.base || '' }}"
          if [ -z "$BASE" ] && [ -n "$LANDING_URL" ]; then
            BASE="$LANDING_URL"
          fi

          CMD=(node scripts/bootstrap-validate.cjs --mode "$MODE")
          if [ -n "$BASE" ]; then
            CMD+=(--base "$BASE")
          fi
          if [ -n "$LOGTO_TOKEN" ]; then
            CMD+=(--token "$LOGTO_TOKEN")
          fi
          if [ -n "$D1_DATABASE_NAME" ]; then
            CMD+=(--d1-name "$D1_DATABASE_NAME")
          fi
          if [ -n "$R2_BUCKET" ]; then
            CMD+=(--r2-bucket "$R2_BUCKET")
          fi

          set +e
          "${CMD[@]}"
          STATUS=$?
          set -e
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-validation
          path: test-results/bootstrap-*
          if-no-files-found: ignore

      - name: Fail if validation failed
        if: steps.run-validation.outputs.status != '0'
        run: exit 1
