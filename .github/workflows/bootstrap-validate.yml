name: Bootstrap Validation

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Force mode (local|remote)'
        required: false
      base:
        description: 'Override base URL'
        required: false

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID || '' }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN || '' }}
      CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID || '' }}
      LOGTO_APPLICATION_ID: ${{ secrets.LOGTO_APPLICATION_ID || '' }}
      LOGTO_TOKEN: ${{ secrets.LOGTO_TOKEN || '' }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY || secrets.STRIPE_TEST_SECRET_KEY || '' }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET || '' }}
      D1_DATABASE_NAME: ${{ secrets.D1_DATABASE_NAME || '' }}
      R2_BUCKET: ${{ secrets.R2_BUCKET || '' }}
      PROJECT_DOMAIN: ${{ secrets.BOOTSTRAP_BASE_URL || secrets.PROJECT_DOMAIN || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Bootstrap preflight
        run: pnpm bootstrap:preflight

      - name: Bootstrap env (write)
        run: pnpm bootstrap:env

      - name: Bootstrap env (check)
        run: pnpm bootstrap:env -- --check

      - name: Bootstrap deploy (dry-run)
        run: pnpm bootstrap:deploy:dry-run

      - name: Bootstrap smoke (minimal)
        run: |
          set -euo pipefail

          BASE="${{ inputs.base || '' }}"
          if [ -z "$BASE" ]; then
            BASE="${PROJECT_DOMAIN:-}"
          fi

          if [ -n "$BASE" ]; then
            MODE="${{ inputs.mode || '' }}"
            if [ -z "$MODE" ]; then
              if [ -n "$CLOUDFLARE_ACCOUNT_ID" ] && [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$STRIPE_SECRET_KEY" ]; then
                MODE="full"
              else
                MODE="minimal"
              fi
            fi

            CMD=(pnpm bootstrap:smoke -- --base "$BASE" --mode "$MODE")
            if [ -n "$LOGTO_TOKEN" ]; then
              CMD+=(--token "$LOGTO_TOKEN")
            fi
            if [ -n "$PROJECT_ID" ]; then
              CMD+=(--project-id "$PROJECT_ID")
            fi
            if [ -n "$D1_DATABASE_NAME" ]; then
              CMD+=(--d1-name "$D1_DATABASE_NAME")
            fi
            if [ -n "$R2_BUCKET" ]; then
              CMD+=(--r2-bucket "$R2_BUCKET")
            fi
            if [ "$MODE" = "minimal" ]; then
              CMD+=(--skip-wrangler)
            fi

            "${CMD[@]}"
          else
            echo "Skipping smoke suite: no base URL provided" >&2
          fi

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-validation
          path: |
            .env.local.generated
            workers/api/wrangler.toml
            test-results/
          if-no-files-found: ignore
