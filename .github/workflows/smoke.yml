name: Smoke Suite

on:
  schedule:
    - cron: '0 4 * * *'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      base:
        description: 'Override base URL (optional)'
        required: false
      mode:
        description: 'Override mode (full|minimal)'
        required: false

jobs:
  smoke:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      ENV_BLOB: ${{ secrets.ENV_BLOB || '' }}
      SMOKE_BASE_OVERRIDE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.base) || secrets.SMOKE_BASE_URL || secrets.PROJECT_DOMAIN || '' }}
      SMOKE_MODE_OVERRIDE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.mode) || secrets.SMOKE_MODE || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure ENV_BLOB secret exists
        run: |
          if [ -z "$ENV_BLOB" ]; then
            echo "ENV_BLOB secret is required" >&2
            exit 1
          fi

      - name: Decode ENV_BLOB to .env.ci
        run: echo "$ENV_BLOB" | base64 --decode > .env.ci

      - name: Export env vars
        run: |
          set -euo pipefail
          while IFS= read -r line; do
            line="${line%%$'\r'}"
            if [ -z "$line" ]; then
              continue
            fi
            var="${line%%=*}"; value="${line#*=}"
            if [ -z "$var" ]; then
              echo "Skipping malformed env line: $line" >&2
              continue
            fi
            trimmed="${value%\r}"
            if [ "${trimmed#\"}" != "$trimmed" ] && [ "${trimmed%\"}" != "$trimmed" ]; then
              trimmed="${trimmed#\"}"
              trimmed="${trimmed%\"}"
            fi
            printf '%s=%s\n' "$var" "$trimmed" >> "$GITHUB_ENV"
          done < <(grep -v '^#' .env.ci)

      - name: Enable corepack
        run: corepack enable

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Bootstrap preflight
        run: pnpm bootstrap:preflight

      - name: Generate bootstrap env
        run: pnpm bootstrap:env

      - name: Validate bootstrap env
        run: pnpm bootstrap:env -- --check

      - name: Bootstrap deploy dry run
        run: pnpm bootstrap:deploy:dry-run

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run smoke suite
        env:
          SMOKE_BASE_OVERRIDE: ${{ env.SMOKE_BASE_OVERRIDE }}
          SMOKE_MODE_OVERRIDE: ${{ env.SMOKE_MODE_OVERRIDE }}
        run: |
          set -euo pipefail

          BASE="${SMOKE_BASE_OVERRIDE:-${SMOKE_BASE_URL:-${PROJECT_DOMAIN:-}}}"
          if [ -z "$BASE" ]; then
            echo "Provide SMOKE_BASE_OVERRIDE, SMOKE_BASE_URL, or PROJECT_DOMAIN via ENV_BLOB" >&2
            exit 1
          fi

          MODE="${SMOKE_MODE_OVERRIDE:-${SMOKE_MODE:-}}"
          if [ -z "$MODE" ]; then
            if [ -z "${D1_DATABASE_NAME:-}" ] || [ -z "${STRIPE_WEBHOOK_SECRET:-}" ]; then
              MODE="minimal"
            else
              MODE="full"
            fi
          fi

          CMD=(pnpm bootstrap:smoke -- --base "$BASE" --mode "$MODE")
          if [ -n "${PROJECT_ID:-}" ]; then
            CMD+=(--project-id "$PROJECT_ID")
          fi
          if [ -n "${D1_DATABASE_NAME:-}" ]; then
            CMD+=(--d1-name "$D1_DATABASE_NAME")
          fi
          if [ -n "${LOGTO_TOKEN:-}" ]; then
            CMD+=(--token "$LOGTO_TOKEN")
          fi
          BUCKET="${R2_BUCKET:-${CLOUDFLARE_R2_BUCKET:-}}"
          if [ -n "$BUCKET" ]; then
            CMD+=(--r2-bucket "$BUCKET")
          fi
          if [ "$MODE" = "minimal" ]; then
            CMD+=(--skip-wrangler)
          fi

          "${CMD[@]}"

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-results
          path: test-results/smoke/
          if-no-files-found: ignore
