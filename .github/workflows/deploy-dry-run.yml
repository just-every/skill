name: Deploy Dry Run (ENV_BLOB)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Why are you running the dry run?'
        required: false

permissions:
  contents: read

jobs:
  dry-run:
    runs-on: ubuntu-latest
    env:
      ENV_BLOB: ${{ secrets.ENV_BLOB || '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Enable Corepack for pnpm
        run: corepack enable pnpm

      - name: Decode ENV_BLOB
        if: env.ENV_BLOB != ''
        run: echo "$ENV_BLOB" | base64 --decode > .env.ci

      - name: Export env vars
        if: env.ENV_BLOB != ''
        run: |
          set -euo pipefail
          while IFS= read -r line; do
            var="${line%%=*}"; value="${line#*=}"
            printf '%s=%s\n' "$var" "$value" >> $GITHUB_ENV
          done < <(grep -v '^#' .env.ci)

      - name: Seed placeholder env
        if: env.ENV_BLOB == ''
        run: |
          {
            echo "PROJECT_ID=ci-placeholder"
            echo "PROJECT_DOMAIN=https://ci-placeholder.justevery.test"
            echo "CLOUDFLARE_ACCOUNT_ID=placeholder-account"
            echo "CLOUDFLARE_API_TOKEN=placeholder-token"
            echo "CLOUDFLARE_ZONE_ID=placeholder-zone"
            echo "D1_DATABASE_NAME=ci-placeholder-d1"
            echo "D1_DATABASE_ID=placeholder-d1-id"
            echo "CLOUDFLARE_R2_BUCKET=ci-placeholder-assets"
            echo "STRIPE_SECRET_KEY=sk_test_placeholder"
            echo "STRIPE_WEBHOOK_SECRET=whsec_placeholder"
            echo "STRIPE_PRODUCTS="
          } > .env.ci
          while IFS= read -r line; do
            var="${line%%=*}"
            value="${line#*=}"
            printf '%s=%s\n' "$var" "$value" >> $GITHUB_ENV
          done < .env.ci

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Render Wrangler config (bootstrap dry-run)
        run: pnpm bootstrap:deploy -- --dry-run --check

      - name: Dry-run migrations
        run: pnpm --filter @justevery/worker run migrate -- --remote --dry-run

      - name: Bootstrap deploy (dry-run)
        run: pnpm bootstrap:deploy:dry-run

      - name: Summarize
        run: echo "Deployment dry run completed" > dry-run-summary.txt

      - uses: actions/upload-artifact@v4
        with:
          name: deploy-dry-run-${{ github.run_id }}
          path: dry-run-summary.txt
